<!DOCTYPE html>
<html>
    <head>
        <title>Genshin Abyss Tourney</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="styles.css">
    </head>
    <div id="profileList"></div>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-custom">
            <div class="container">
                <a class="navbar-brand" href="home.html">GITV</a>
                <div class="navbar-nav">                    
                    <a class="nav-link" href="home.html">Home</a>
                    <a class="nav-link" href="index.html">Stats</a>
                    <a class="nav-link" href="tournaments.html">Tournaments</a>
                    <a class="nav-link" href="news.html">News</a>
                    <a class="nav-link active" href="players.html">Players Profiles</a>
                </div>
                <form class="d-flex ms-auto" style="position: relative;">
                    <input class="form-control me-2" type="search" id="globalSearch" placeholder="Search players...">
                    <button class="btn btn-outline-light" type="submit">Search</button>
                    <div id="suggestions" class="suggestions"></div>
                </form>
            </div>    
        </nav>
        <div class="container">
            <h1 class="text-center mt-4">Players Profiles</h1>
            <div class="row" id="profileList"></div>
        </div>
        <script>
            fetch('./results.json')
                .then(response => response.json())
                .then(data => {
                    // Search (same as index.html)
                    const search = document.getElementById('globalSearch');
                    const suggestions = document.getElementById('suggestions');
                    search.addEventListener('input', () => {
                        const term = search.value.toLowerCase();
                        suggestions.innerHTML = '';
                        if (term) {
                            const playerMatches = data.filter(row => row.player.toLowerCase().includes(term)).map(row => row.player);
                            const heroMatches = data.flatMap(row => row.roster.split(',').map(h => h.trim())).filter(hero => hero.toLowerCase().includes(term));
                            const matches = [...new Set([...playerMatches, ...heroMatches])];
                            matches.forEach(item => {
                                const div = document.createElement('div');
                                div.textContent = item;
                                div.addEventListener('click', () => {
                                    search.value = item;
                                    suggestions.innerHTML = '';
                                    filterContent(item);
                                });
                                suggestions.appendChild(div);
                            });
                        }
                        filterContent(term);
                    });
                    document.querySelector('form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        filterContent(search.value.toLowerCase());
                    });
                     // Profiles
                const profiles = {};
                data.forEach(row => {
                    const player = row.player;
                    if (!profiles[player]) {
                        profiles[player] = { runs: 0, bestTime: null, heroes: {} };
                    }
                    profiles[player].runs++;
                    const time1Sec = row.time1.split(':').reduce((acc, t) => acc * 60 + +t, 0);
                    if (!profiles[player].bestTime || time1Sec < profiles[player].bestTime) {
                        profiles[player].bestTime = time1Sec;
                    }
                    row.roster.split(',').forEach(h => {
                        h = h.trim();
                        profiles[player].heroes[h] = (profiles[player].heroes[h] || 0) + 1;
                    });
                });

                const profileList = document.getElementById('profileList');
                Object.entries(profiles).forEach(([player, stats]) => {
                    const bestTimeStr = `${Math.floor(stats.bestTime / 60)}:${(stats.bestTime % 60).toString().padStart(2, '0')}`;
                    const topHero = Object.entries(stats.heroes).sort((a, b) => b[1] - a[1])[0][0];
                    profileList.innerHTML += `
                        <div class="col-md-4 mb-3">
                            <div class="card bg-dark text-white">
                                <div class="card-body">
                                    <h5 class="card-title">${player}</h5>
                                    <p class="card-text">Runs: ${stats.runs}</p>
                                    <p class="card-text">Best Time: ${bestTimeStr}</p>
                                    <p class="card-text">Top Hero: ${topHero}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                function filterContent(term) {
                    const cards = profileList.querySelectorAll('.col-md-4');
                    cards.forEach(card => {
                        const player = card.querySelector('.card-title').textContent.toLowerCase();
                        const heroes = card.querySelectorAll('.card-text')[2].textContent.toLowerCase(); // Top Hero
                        card.style.display = (player.includes(term) || heroes.includes(term)) ? '' : 'none';
                    });
                }
            })
            .catch(error => console.error('Error fetching results:', error));
        </script>
    </body>
</html>